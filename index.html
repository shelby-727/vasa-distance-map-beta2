<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VASA Clubs — Executive Distance Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#f6f7fb;
      --text:#111827;
      --muted:#6b7280;
      --line:rgba(17,24,39,0.12);
      --accent:#2563eb;
      --shadow: 0 10px 28px rgba(0,0,0,.12);
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }
    .wrap { display:flex; height:100vh; width:100vw; overflow:hidden; }
    #map { flex:1 1 auto; }

    .panel {
      width: 420px;
      max-width: 52vw;
      min-width: 320px;
      border-left: 1px solid var(--line);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;
      z-index: 1500;
    }

    .header {
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.90);
      margin-bottom: 12px;
    }
    .h-title { font-weight:900; letter-spacing:.2px; font-size:14px; }
    .h-sub { color:var(--muted); font-size:12px; margin-top:2px; }

    .section {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.92);
    }
    .section h3 { margin:0 0 8px; font-size:13px; letter-spacing:.2px; }

    .muted { color:var(--muted); font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, button {
      font-family: var(--font);
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      padding: 9px 10px;
      outline: none;
    }
    input::placeholder { color: rgba(107,114,128,0.8); }

    button {
      cursor:pointer;
      background: rgba(37,99,235,0.10);
      border-color: rgba(37,99,235,0.28);
      color: #0f172a;
    }
    button:hover { background: rgba(37,99,235,0.16); }
    button.secondary { background: #fff; border-color: var(--line); color: var(--text); }

    .pill {
      display:inline-flex; gap:6px; align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(17,24,39,0.04);
      font-size:12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill strong { color: var(--text); }

    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding: 9px 8px; border-bottom: 1px solid rgba(17,24,39,0.10); font-size: 12px; vertical-align: top; }
    th { color: var(--muted); font-weight: 700; }
    tr:hover { background: rgba(37,99,235,0.06); cursor:pointer; }

    .label-tooltip {
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(17,24,39,0.18);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      font-weight: 800;
      font-size: 11px;
    }

    .hamburger{
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 2000;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,0.16);
      background: rgba(255,255,255,0.92);
      color: var(--text);
      cursor: pointer;
      display: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.10);
    }

    @media (max-width: 820px){
      .hamburger{
        display: inline-flex;
        align-items:center;
        justify-content:center;
      }
      #sidePanel{
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: min(420px, 92vw);
        max-width: 92vw;
        transform: translateX(100%);
        transition: transform .2s ease;
      }
      #sidePanel.open{
        transform: translateX(0);
      }
    }
  </style>
</head>

<body>
  <button id="panelToggle" class="hamburger" type="button" aria-label="Toggle panel">☰</button>

  <div class="wrap">
    <div id="map"></div>

    <div class="panel" id="sidePanel">
      <div class="header">
        <div class="h-title">VASA Club Coverage Map</div>
        <div class="h-sub">Click a club pin to view coverage radius and nearby clubs.</div>
      </div>

      <div class="section">
        <h3>Coverage</h3>
        <div class="row">
          <span class="muted">Radius (miles):</span>
          <input id="radius" type="number" min="0" step="5" value="50" />
          <button id="clearLines" class="secondary" type="button">Clear</button>
          <button id="toggleLabels" type="button">Hide labels</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill">Labels at zoom <strong>12+</strong></span>
          <span class="pill">Lines: <strong>nearest 10</strong></span>
        </div>
      </div>

      <div class="section">
        <h3>Selected club</h3>
        <div id="selected" class="muted">No club selected yet.</div>

        <div class="row" style="margin-top:10px;">
          <span id="kpiWithin" class="pill" style="display:none;">Within radius: <strong>0</strong></span>
          <span id="kpiNearest" class="pill" style="display:none;">Nearest: <strong>—</strong></span>
        </div>

        <div id="summary" class="muted" style="margin-top:10px;"></div>

        <table id="results" style="display:none;">
          <thead>
            <tr><th>Club</th><th>Distance</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

<script>
  // ---------- Helpers ----------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function fieldLine(label, value) {
    const v = (value === null || value === undefined) ? "" : String(value).trim();
    if (!v) return "";
    return `<div><span class="muted">${esc(label)}:</span> ${esc(v)}</div>`;
  }

  function haversineMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 3958.7613;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function getRadiusMiles() {
    const v = Number(document.getElementById('radius').value || 0);
    return Number.isFinite(v) ? Math.max(0, v) : 0;
  }

  // ---------- Map ----------
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Use LOCAL Leaflet marker icons (repo root)
  L.Icon.Default.mergeOptions({
    iconRetinaUrl: './marker-icon-2x.png',
    iconUrl: './marker-icon.png',
    shadowUrl: './marker-shadow.png'
  });

  const lineLayer = L.layerGroup().addTo(map);

  let clubs = [];
  let markers = []; // {marker, club}
  let selectedClub = null;

  // Coverage circle
  let radiusCircle = null;

  function drawRadiusCircle(lat, lng, miles) {
    const m = Number(miles || 0);
    if (radiusCircle) {
      map.removeLayer(radiusCircle);
      radiusCircle = null;
    }
    if (!m || m <= 0) return;

    const meters = m * 1609.34;
    radiusCircle = L.circle([lat, lng], {
      radius: meters,
      color: '#2563eb',
      weight: 2,
      opacity: 0.85,
      fillOpacity: 0.08
    }).addTo(map);
  }

  // Labels
  let labelsEnabled = true;
  const labelZoomThreshold = 12;

  function updateLabels() {
    const z = map.getZoom();
    markers.forEach(({marker, club}) => {
      if (!labelsEnabled || z < labelZoomThreshold) {
        marker.unbindTooltip();
        return;
      }
      if (!marker.getTooltip()) {
        marker.bindTooltip(esc(club.name), {
          permanent: true,
          direction: "top",
          offset: [0, -10],
          className: "label-tooltip"
        });
      }
    });
  }
  map.on('zoomend', updateLabels);

  function clearVisuals() {
    lineLayer.clearLayers();
    if (radiusCircle) {
      map.removeLayer(radiusCircle);
      radiusCircle = null;
    }
  }

  function drawLinesToNearest(limit = 10) {
    lineLayer.clearLayers();
    if (!selectedClub) return;

    const sorted = clubs
      .filter(c => c !== selectedClub)
      .map(c => ({club: c, miles: haversineMiles(selectedClub.lat, selectedClub.lng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles)
      .slice(0, limit);

    sorted.forEach(({club}) => {
      L.polyline([[selectedClub.lat, selectedClub.lng],[club.lat, club.lng]], {
        weight: 2,
        opacity: 0.55
      }).addTo(lineLayer);
    });
  }

  function renderDistances() {
    if (!selectedClub) return;

    const radiusMiles = getRadiusMiles();

    const allRows = clubs
      .filter(c => c !== selectedClub)
      .map(c => ({club: c, miles: haversineMiles(selectedClub.lat, selectedClub.lng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles);

    const rows = radiusMiles > 0
      ? allRows.filter(x => x.miles <= radiusMiles)
      : allRows;

    // Selected summary (exec-friendly)
    document.getElementById('selected').innerHTML =
      `<div><b>${esc(selectedClub.name)}</b></div>
       <div class="muted">${esc(selectedClub.address || "")}</div>`;

    // KPIs
    const kpiWithin = document.getElementById('kpiWithin');
    const kpiNearest = document.getElementById('kpiNearest');
    if (kpiWithin) {
      kpiWithin.style.display = selectedClub ? "inline-flex" : "none";
      kpiWithin.innerHTML = `Within radius: <strong>${rows.length}</strong>`;
    }
    if (kpiNearest) {
      const nearest = allRows[0];
      kpiNearest.style.display = nearest ? "inline-flex" : "none";
      kpiNearest.innerHTML = nearest
        ? `Nearest: <strong>${esc(nearest.club.name)} (${nearest.miles.toFixed(1)} mi)</strong>`
        : `Nearest: <strong>—</strong>`;
    }

    // Table
    const tbody = document.querySelector('#results tbody');
    tbody.innerHTML = "";
    rows.forEach(({club, miles}) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight:800;">${esc(club.name)}</div>
          <div class="muted">${esc(club.address || "")}</div>
        </td>
        <td><span class="pill"><strong>${miles.toFixed(1)}</strong>&nbsp;mi</span></td>
      `;
      tr.addEventListener('click', () => map.setView([club.lat, club.lng], 13));
      tbody.appendChild(tr);
    });

    document.getElementById('results').style.display = "table";
    document.getElementById('summary').innerHTML =
      radiusMiles > 0
        ? `Showing <b>${rows.length}</b> clubs within <b>${radiusMiles}</b> miles of the selected club.`
        : `Showing <b>${rows.length}</b> clubs (all clubs) from the selected club.`;

    // Visuals
    drawRadiusCircle(selectedClub.lat, selectedClub.lng, radiusMiles);
  }

  // ---------- Mobile drawer ----------
  const panel = document.getElementById("sidePanel");
  const toggleBtn = document.getElementById("panelToggle");

  function syncPanelForScreen() {
    if (!panel) return;
    if (window.matchMedia("(max-width: 820px)").matches) {
      panel.classList.remove("open");
    } else {
      panel.classList.add("open");
    }
  }
  syncPanelForScreen();
  window.addEventListener("resize", syncPanelForScreen);

  toggleBtn?.addEventListener("click", () => {
    panel?.classList.toggle("open");
  });

  function onSelectClub(club) {
    selectedClub = club;

    // open panel on mobile so the “exec view” appears immediately
    if (window.matchMedia("(max-width: 820px)").matches) {
      panel?.classList.add("open");
    }

    renderDistances();
    drawLinesToNearest(10);
    map.setView([club.lat, club.lng], Math.max(map.getZoom(), 11));
  }

  // ---------- Load clubs ----------
  fetch('./clubs.json')
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      clubs = (data || [])
        .map(c => ({...c, lat: Number(c.lat), lng: Number(c.lng)}))
        .filter(c => Number.isFinite(c.lat) && Number.isFinite(c.lng));

      const bounds = [];
      clubs.forEach(club => {
        const marker = L.marker([club.lat, club.lng]).addTo(map);

        marker.bindPopup(`
          <div style="font-weight:900; font-size:16px; margin-bottom:4px;">${esc(club.name)}</div>
          <div class="muted" style="margin-bottom:6px;">${esc(club.address || "")}</div>

          ${fieldLine("GM", club["GM"])}
          ${fieldLine("GM Cell", club["GM CELL"])}
          ${fieldLine("MEL", club["MEL"])}
          ${fieldLine("MT", club["MT"])}
          ${fieldLine("MT Cell", club["MT CELL"])}
        `);

        marker.on('click', () => onSelectClub(club));

        markers.push({ marker, club });
        bounds.push([club.lat, club.lng]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
      updateLabels();
    })
    .catch(err => {
      console.error(err);
      alert("Could not load clubs.json. Make sure it’s in the same folder as index.html and valid JSON.");
    });

  // ---------- UI wiring ----------
  document.getElementById('radius').addEventListener('input', () => {
    if (!selectedClub) return;
    renderDistances();
    drawLinesToNearest(10);
  });

  document.getElementById('clearLines').addEventListener('click', () => {
    clearVisuals();
    document.getElementById('results').style.display = selectedClub ? "table" : "none";
  });

  document.getElementById('toggleLabels').addEventListener('click', () => {
    labelsEnabled = !labelsEnabled;
    document.getElementById('toggleLabels').textContent = labelsEnabled ? "Hide labels" : "Show labels";
    updateLabels();
  });
</script>
</body>
</html>
