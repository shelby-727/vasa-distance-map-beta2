<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VASA Clubs â€” Distance Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#f6f7fb;
      --text:#111827;
      --muted:#6b7280;
      --line:rgba(17,24,39,0.12);
      --accent:#2563eb;
      --danger:#dc2626;
      --shadow: 0 10px 28px rgba(0,0,0,.12);
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }
    .wrap { display:flex; height:100vh; width:100vw; overflow:hidden; }
    #map { flex:1 1 auto; }

    .panel {
      width: 420px;
      max-width: 52vw;
      min-width: 320px;
      border-left: 1px solid var(--line);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;
      z-index: 1500;
    }

    .header {
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.95);
      margin-bottom: 12px;
    }
    .h-title { font-weight:900; letter-spacing:.2px; font-size:14px; }
    .h-sub { color:var(--muted); font-size:12px; margin-top:2px; }

    .section {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.95);
    }
    .section h3 { margin:0 0 8px; font-size:13px; letter-spacing:.2px; }

    .muted { color:var(--muted); font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, button, a.btnlink {
      font-family: var(--font);
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      padding: 9px 10px;
      outline: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    button {
      cursor:pointer;
      background: rgba(37,99,235,0.10);
      border-color: rgba(37,99,235,0.28);
      color: #0f172a;
    }
    button:hover { background: rgba(37,99,235,0.16); }
    button.secondary { background: #fff; border-color: var(--line); color: var(--text); }
    button.danger { background: rgba(220,38,38,0.10); border-color: rgba(220,38,38,0.30); }

    .pill {
      display:inline-flex; gap:6px; align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(17,24,39,0.04);
      font-size:12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill strong { color: var(--text); }

    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding: 9px 8px; border-bottom: 1px solid rgba(17,24,39,0.10); font-size: 12px; vertical-align: top; }
    th { color: var(--muted); font-weight: 700; }
    tr:hover { background: rgba(37,99,235,0.06); cursor:pointer; }

    /* Mobile drawer */
    .hamburger{
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 2000;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,0.16);
      background: rgba(255,255,255,0.92);
      color: var(--text);
      cursor: pointer;
      display: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.10);
    }

    @media (max-width: 820px){
      .hamburger{
        display: inline-flex;
        align-items:center;
        justify-content:center;
      }
      #sidePanel{
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        width: min(420px, 92vw);
        max-width: 92vw;
        transform: translateX(100%);
        transition: transform .2s ease;
      }
      #sidePanel.open{
        transform: translateX(0);
      }
    }

    .routeStops { margin-top: 6px; line-height: 1.5; }
    .smallNote { font-size: 11px; color: var(--muted); margin-top: 6px; }
  </style>
</head>

<body>
  <button id="panelToggle" class="hamburger" type="button" aria-label="Toggle panel">â˜°</button>

  <div class="wrap">
    <div id="map"></div>

    <div class="panel" id="sidePanel">
      <div class="header">
        <div class="h-title">VASA Distance Finder</div>
        <div class="h-sub">Click pins to build a route (click again to remove). Red line = route.</div>
      </div>

      <div class="section">
        <h3>Route Builder</h3>
        <div id="routeList" class="muted routeStops">No stops yet.</div>

        <div class="row" style="margin-top:10px;">
          <button id="routeUndo" type="button" class="secondary">Undo</button>
          <button id="routeClear" type="button" class="danger">Clear</button>

          <a id="gmapsLink" class="btnlink"
             href="#"
             target="_blank"
             rel="noopener"
             style="display:none;">
            Open in Google Maps
          </a>
        </div>

        <div class="smallNote">Tip: Click Club 1 â†’ Club 2 â†’ Club 3â€¦ Link updates automatically.</div>
      </div>

      <div class="section">
        <h3>Distance options</h3>
        <div class="row">
          <span class="muted">Within (miles):</span>
          <input id="radius" type="number" min="0" step="5" value="0" />
          <button id="clearLines" class="secondary" type="button">Clear lines</button>
        </div>
      </div>

      <div class="section">
        <h3>Selected club</h3>
        <div id="selected" class="muted">No club selected yet.</div>
        <div id="summary" class="muted" style="margin-top:10px;"></div>

        <table id="results" style="display:none;">
          <thead>
            <tr><th>Club</th><th>Distance</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

<script>
  // ---------- Helpers ----------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function fieldLine(label, value) {
    const v = (value === null || value === undefined) ? "" : String(value).trim();
    if (!v) return "";
    return `<div><span class="muted">${esc(label)}:</span> ${esc(v)}</div>`;
  }

  function haversineMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 3958.7613;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function clubKey(club){
    return String(club.id ?? `${club.name}|${club.lat}|${club.lng}`);
  }

  // ---------- Map ----------
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Local marker icons
  L.Icon.Default.mergeOptions({
    iconRetinaUrl: './marker-icon-2x.png',
    iconUrl: './marker-icon.png',
    shadowUrl: './marker-shadow.png'
  });

  // Blue nearest lines (optional)
  const lineLayer = L.layerGroup().addTo(map);

  // Route highlights + route line (RED)
  const routeLayer = L.layerGroup().addTo(map);

  let clubs = [];
  let selectedClub = null;

  // ---------- Route Builder ----------
  let routeClubs = [];
  let routeLine = null;
  let routeHighlights = new Map(); // key -> circleMarker

  function setRouteHighlight(club, on) {
    const key = clubKey(club);

    if (on) {
      if (routeHighlights.has(key)) return;
      const ring = L.circleMarker([club.lat, club.lng], {
        radius: 10,
        weight: 4,
        opacity: 0.95,
        fillOpacity: 0.15
      });
      ring.setStyle({ color: "red", fillColor: "red" });
      ring.addTo(routeLayer);
      routeHighlights.set(key, ring);
    } else {
      const ring = routeHighlights.get(key);
      if (ring) {
        routeLayer.removeLayer(ring);
        routeHighlights.delete(key);
      }
    }
  }

  function drawRouteLine() {
    if (routeLine) {
      routeLayer.removeLayer(routeLine);
      routeLine = null;
    }
    if (routeClubs.length < 2) return;

    const latlngs = routeClubs.map(c => [c.lat, c.lng]);
    routeLine = L.polyline(latlngs, {
      weight: 6,
      opacity: 0.9,
      lineJoin: "round",
      lineCap: "round"
    });
    routeLine.setStyle({ color: "red" });
    routeLine.addTo(routeLayer);
  }

  function buildGoogleMapsDirectionsUrl(route) {
    if (route.length < 2) return null;

    const origin = `${route[0].lat},${route[0].lng}`;
    const destination = `${route[route.length - 1].lat},${route[route.length - 1].lng}`;

    const waypoints = route.length > 2
      ? route.slice(1, -1).map(c => `${c.lat},${c.lng}`).join('|')
      : "";

    const params = new URLSearchParams({ api: "1", origin, destination });
    if (waypoints) params.set("waypoints", waypoints);

    return `https://www.google.com/maps/dir/?${params.toString()}`;
  }

  function renderRouteUI() {
    const list = document.getElementById("routeList");
    const link = document.getElementById("gmapsLink");

    if (routeClubs.length === 0) {
      list.textContent = "No stops yet.";
      link.style.display = "none";
      return;
    }

    list.innerHTML = routeClubs.map((c, i) => {
      const label =
        i === 0 ? "Start" :
        i === routeClubs.length - 1 ? "Destination" :
        `Stop ${i}`;
      return `ðŸ”´ ${label}: <b>${esc(c.name)}</b>`;
    }).join("<br>");

    const url = buildGoogleMapsDirectionsUrl(routeClubs);
    if (url) {
      link.href = url;
      link.style.display = "inline-flex";
    } else {
      link.style.display = "none";
    }
  }

  function toggleClubInRoute(club) {
    const key = clubKey(club);
    const idx = routeClubs.findIndex(c => clubKey(c) === key);

    if (idx >= 0) {
      // remove (de-select)
      routeClubs.splice(idx, 1);
      setRouteHighlight(club, false);
    } else {
      // add
      routeClubs.push(club);
      setRouteHighlight(club, true);
    }

    renderRouteUI();
    drawRouteLine();
  }

  function undoRoute() {
    const removed = routeClubs.pop();
    if (removed) setRouteHighlight(removed, false);
    renderRouteUI();
    drawRouteLine();
  }

  function clearRoute() {
    routeClubs.forEach(c => setRouteHighlight(c, false));
    routeClubs = [];
    renderRouteUI();
    drawRouteLine();
  }

  // ---------- Distances ----------
  function clearLines() { lineLayer.clearLayers(); }

  function renderDistances() {
    if (!selectedClub) return;

    const radiusMiles = Number(document.getElementById('radius').value || 0);

    const rows = clubs
      .filter(c => clubKey(c) !== clubKey(selectedClub))
      .map(c => ({club: c, miles: haversineMiles(selectedClub.lat, selectedClub.lng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles)
      .filter(x => radiusMiles <= 0 ? true : x.miles <= radiusMiles);

    document.getElementById('selected').innerHTML =
      `<div><b>${esc(selectedClub.name)}</b></div>
       <div class="muted">${esc(selectedClub.address || "")}</div>`;

    const tbody = document.querySelector('#results tbody');
    tbody.innerHTML = "";

    rows.forEach(({club, miles}) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight:800;">${esc(club.name)}</div>
          <div class="muted">${esc(club.address || "")}</div>
        </td>
        <td><span class="pill"><strong>${miles.toFixed(1)}</strong>&nbsp;mi</span></td>
      `;
      tr.addEventListener('click', () => map.setView([club.lat, club.lng], 13));
      tbody.appendChild(tr);
    });

    document.getElementById('results').style.display = "table";
    document.getElementById('summary').innerHTML =
      `Showing <b>${rows.length}</b> clubs ${radiusMiles > 0 ? `within <b>${radiusMiles}</b> miles` : "(all clubs)"} of the selected club.`;
  }

  // ---------- Mobile drawer ----------
  const panel = document.getElementById("sidePanel");
  const toggleBtn = document.getElementById("panelToggle");

  function syncPanelForScreen() {
    if (!panel) return;
    if (window.matchMedia("(max-width: 820px)").matches) {
      panel.classList.remove("open");
    } else {
      panel.classList.add("open");
    }
  }
  syncPanelForScreen();
  window.addEventListener("resize", syncPanelForScreen);

  toggleBtn?.addEventListener("click", () => panel?.classList.toggle("open"));

  function onSelectClub(club) {
    selectedClub = club;

    if (window.matchMedia("(max-width: 820px)").matches) {
      panel?.classList.add("open");
    }

    renderDistances();
    map.setView([club.lat, club.lng], Math.max(map.getZoom(), 11));
  }

  // ---------- Load clubs ----------
  fetch('./clubs.json')
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      clubs = (data || [])
        .map(c => ({...c, lat: Number(c.lat), lng: Number(c.lng)}))
        .filter(c => Number.isFinite(c.lat) && Number.isFinite(c.lng));

      const bounds = [];

      clubs.forEach(club => {
        const marker = L.marker([club.lat, club.lng]).addTo(map);

        // Popup: ONLY fields you want (prevents $ junk)
        marker.bindPopup(`
          <div style="font-weight:900; font-size:16px; margin-bottom:4px;">${esc(club.name)}</div>
          <div class="muted" style="margin-bottom:10px;">${esc(club.address || "")}</div>

          ${fieldLine("GM", club["GM"])}
          ${fieldLine("GM Cell", club["GM CELL"])}
          ${fieldLine("MEL", club["MEL"])}
          ${fieldLine("MT", club["MAINTENANCE TECH"])}
          ${fieldLine("MT Phone", club["MT PHONE"])}
        `);

        marker.on('click', () => {
          onSelectClub(club);
          toggleClubInRoute(club); // click again removes
        });

        bounds.push([club.lat, club.lng]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
    })
    .catch(err => {
      console.error(err);
      alert("Could not load clubs.json. Make sure itâ€™s in the same folder as index.html and valid JSON.");
    });

  // ---------- UI wiring ----------
  document.getElementById('radius').addEventListener('input', () => renderDistances());
  document.getElementById('clearLines').addEventListener('click', clearLines);

  document.getElementById("routeUndo").addEventListener("click", undoRoute);
  document.getElementById("routeClear").addEventListener("click", clearRoute);

  // Expose for inline safety (not required but fine)
  window.undoRoute = undoRoute;
  window.clearRoute = clearRoute;

  renderRouteUI();
</script>
</body>
</html>
