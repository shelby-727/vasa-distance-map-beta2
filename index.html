<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VASA Clubs â€” Distance Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    .wrap { display:flex; height:100vh; }
    #map { flex: 1; }
    .panel {
      width: 400px;
      border-left: 1px solid #ddd;
      padding: 12px;
      overflow:auto;
      background:#fff;
    }
    .title { font-weight: bold; margin-bottom: 8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 6px; border-bottom: 1px solid #eee; font-size: 13px; }
    tr:hover { background:#f9f9f9; cursor:pointer; }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>

  <div class="panel">
    <div class="title">Distance Finder</div>
    <div id="selected">Click a club to see distances.</div>
    <br>
    <table id="results" style="display:none;">
      <thead>
        <tr><th>Club</th><th>Miles</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  function haversineMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 3958.8;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  const map = L.map('map').setView([39.5, -98.35], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
  }).addTo(map);

  fetch('clubs.json')
    .then(r => r.json())
    .then(clubs => {

      clubs = clubs.filter(c => typeof c.lat === "number" && typeof c.lng === "number");

      const bounds = [];

      clubs.forEach(club => {
        const marker = L.marker([club.lat, club.lng]).addTo(map);

        marker.bindPopup("<b>" + club.name + "</b><br>" + club.address);

        marker.on('click', () => {
          document.getElementById('selected').innerHTML =
            "<b>" + club.name + "</b><br>" + club.address;

          const tbody = document.querySelector('#results tbody');
          tbody.innerHTML = "";

          const rows = clubs
            .filter(c => c.id !== club.id)
            .map(c => ({
              club: c,
              miles: haversineMiles(club.lat, club.lng, c.lat, c.lng)
            }))
            .sort((a,b) => a.miles - b.miles);

          rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML =
              "<td>" + r.club.name + "</td>" +
              "<td>" + r.miles.toFixed(1) + "</td>";
            tbody.appendChild(tr);
          });

          document.getElementById('results').style.display = "table";
        });

        bounds.push([club.lat, club.lng]);
      });

      if (bounds.length) {
        map.fitBounds(bounds);
      }

    })
    .catch(err => {
      alert("Error loading clubs.json");
      console.error(err);
    });
</script>
</body>
</html>
