<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VASA Clubs — Distance Finder (Beta)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#101f38;
      --text:#eaf0ff;
      --muted:#a9b8df;
      --line:rgba(255,255,255,0.10);
      --accent:#7aa7ff;
      --danger:#ff6b6b;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --radius: 16px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }
    .wrap { display:flex; height:100vh; width:100vw; overflow:hidden; }
    #map { flex:1 1 auto; }

    .panel {
      width: 480px;
      max-width: 50vw;
      min-width: 360px;
      border-left: 1px solid var(--line);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;
    }
    .header {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px; border:1px solid var(--line); border-radius: var(--radius);
      background: rgba(255,255,255,0.03);
    }
    .h-title { font-weight:900; letter-spacing:.2px; font-size:14px; }
    .h-sub { color:var(--muted); font-size:12px; margin-top:2px; }
    .badge { font-size:11px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,0.04); }

    .section {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.03);
    }
    .section h3 { margin:0 0 8px; font-size:13px; letter-spacing:.2px; }
    .muted { color:var(--muted); font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .tiny { font-size:11px; color: rgba(234,240,255,0.60); line-height:1.35; margin-top:8px; }

    input, button {
      font-family: var(--font);
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 9px 10px;
      outline: none;
    }
    input::placeholder { color: rgba(234,240,255,0.55); }
    button {
      cursor:pointer;
      background: rgba(122,167,255,0.15);
      border-color: rgba(122,167,255,0.30);
    }
    button:hover { background: rgba(122,167,255,0.22); }
    button.secondary { background: rgba(255,255,255,0.04); border-color: var(--line); }
    button.danger { background: rgba(255,107,107,0.15); border-color: rgba(255,107,107,0.35); }

    .pill {
      display:inline-flex; gap:6px; align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      font-size:12px;
      color: var(--muted);
    }
    .pill strong { color: var(--text); }

    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding: 9px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 12px; vertical-align: top; }
    th { color: var(--muted); font-weight: 700; }
    tr:hover { background: rgba(255,255,255,0.03); cursor:pointer; }

    .kv { margin-top:10px; border-top: 1px dashed rgba(255,255,255,0.15); padding-top:10px; }
    .kv .kvrow { display:flex; gap:12px; padding:6px 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
    .kv .k { width: 160px; font-weight: 900; color: rgba(234,240,255,0.92); font-size:11px; }
    .kv .v { flex: 1; color: rgba(234,240,255,0.85); font-size:11px; word-break: break-word; }

    .label-tooltip {
      background: rgba(15,26,46,0.92);
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      font-weight: 900;
      font-size: 11px;
    }

    .toast {
      margin-top:10px;
      padding:10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      font-size: 12px;
      color: var(--muted);
    }
    .toast strong { color: var(--text); }
  </style>
</head>

<body>
<div class="wrap">
  <div id="map"></div>

  <div class="panel">
    <div class="header">
      <div>
        <div class="h-title">VASA Leadership Distance Tool</div>
        <div class="h-sub">Beta sandbox — safe to experiment.</div>
      </div>
      <div class="badge">BETA</div>
    </div>

    <div class="section">
      <h3>Status</h3>
      <div class="row">
        <div class="pill">Clubs loaded: <strong id="clubCount">0</strong></div>
        <div class="pill">Mode: <strong id="modeLabel">Click a club</strong></div>
      </div>
      <div id="statusMsg" class="toast">Loading clubs.json…</div>
    </div>

    <div style="margin-top:15px; padding-top:10px; border-top:1px solid #ddd;">
  <div style="font-weight:600; margin-bottom:6px;">Route Builder</div>

  <div id="routeList" class="muted">No stops yet.</div>

  <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
    <button id="routeUndo" type="button">Undo</button>
    <button id="routeClear" type="button">Clear</button>

    <a id="gmapsLink"
       href="#"
       target="_blank"
       rel="noopener"
       style="display:none; padding:6px 10px; border:1px solid #ccc; border-radius:6px; text-decoration:none;">
      Open in Google Maps
    </a>
  </div>
</div>
    
    <div class="section">
      <h3>Search club</h3>
      <div class="row" style="width:100%;">
        <input id="searchInput" style="flex:1 1 240px;" placeholder="Type a club name (e.g., Brickyard)"/>
        <button id="searchGo">Go</button>
        <button id="searchClear" class="secondary">Clear</button>
      </div>
      <div class="tiny">Tip: After “Go”, the club is selected and distances load automatically.</div>
    </div>

    <div class="section">
      <h3>Custom starting point</h3>
      <div class="muted">Distances from a non-club location.</div>

      <div class="row" style="margin-top:10px;">
        <input id="customLatLng" style="flex:1 1 300px;" placeholder="Enter lat,lng (example: 40.7608,-111.8910)"/>
        <button id="setLatLng">Set</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="customAddress" style="flex:1 1 300px;" placeholder="Or enter an address to geocode"/>
        <button id="geocodeAddress">Geocode</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="useClickedPoint" class="secondary">Pick point on map</button>
        <button id="clearCustom" class="danger">Clear custom</button>
      </div>

      <div class="tiny">
        Address geocoding uses OpenStreetMap Nominatim. If it rate-limits, use <b>lat,lng</b> or “Pick point on map”.
      </div>
    </div>

    <div class="section">
      <h3>Distance options</h3>
      <div class="row">
        <span class="muted">Within (miles):</span>
        <input id="radius" type="number" min="0" step="5" value="0" />
        <button id="clearLines" class="secondary">Clear lines</button>
        <button id="toggleLabels">Hide labels</button>
      </div>
      <div class="tiny">Labels appear when zoomed in, and can be toggled.</div>
    </div>

    <div class="section" id="detailsSection">
      <h3>Selected</h3>
      <div id="selected" class="muted">Click a club marker, or set a custom point.</div>
      <div id="details" style="display:none;"></div>
      <div id="summary" class="muted" style="margin-top:10px;"></div>

      <table id="results" style="display:none;">
        <thead>
          <tr><th>Club</th><th>Distance</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<script>
  // ---------- Helpers ----------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function haversineMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 3958.7613;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function parseLatLng(text) {
    const t = (text || "").trim();
    const m = t.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
    if (!m) return null;
    const lat = Number(m[1]), lng = Number(m[3]);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
    if (lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
    return {lat, lng};
  }

  function kvHtmlAllColumns(obj) {
    // Show ALL columns (every field from clubs.json), except we hide lat/lng and id at the top area already.
    const skip = new Set(["lat","lng"]);
    const keys = Object.keys(obj || {}).filter(k => !skip.has(k) && obj[k] !== null && obj[k] !== "" && obj[k] !== undefined);

    // Put common ones first, then alphabetical
    const preferred = ["id","name","address"];
    keys.sort((a,b) => {
      const ia = preferred.indexOf(a), ib = preferred.indexOf(b);
      if (ia !== -1 || ib !== -1) return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
      return a.localeCompare(b);
    });

    return `<div class="kv">${
      keys.map(k => `
        <div class="kvrow">
          <div class="k">${esc(k)}</div>
          <div class="v">${esc(obj[k])}</div>
        </div>
      `).join("")
    }</div>`;
  }

  function setStatus(html) {
    document.getElementById('statusMsg').innerHTML = html;
  }

  // ---------- Map ----------
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const lineLayer = L.layerGroup().addTo(map);

  let clubs = [];
  let markers = []; // {marker, club}
  let selected = null;
  let selectedType = "none"; // "club" | "custom"

  // Labels
  let labelsEnabled = true;
  const labelZoomThreshold = 12;

  function updateLabels() {
    const z = map.getZoom();
    markers.forEach(({marker, club}) => {
      if (!labelsEnabled || z < labelZoomThreshold) {
        marker.unbindTooltip();
        return;
      }
      if (!marker.getTooltip()) {
        marker.bindTooltip(esc(club.name), {
          permanent: true,
          direction: "top",
          offset: [0, -10],
          className: "label-tooltip"
        });
      }
    });
  }
  map.on('zoomend', updateLabels);

  // ===== Route Builder =====
let routeClubs = [];

function buildGoogleMapsDirectionsUrl(route) {
  if (route.length < 2) return null;

  const origin = `${route[0].lat},${route[0].lng}`;
  const destination = `${route[route.length - 1].lat},${route[route.length - 1].lng}`;

  const waypoints = route.length > 2
    ? route.slice(1, -1).map(c => `${c.lat},${c.lng}`).join('|')
    : "";

  const params = new URLSearchParams({
    api: "1",
    origin,
    destination
  });

  if (waypoints) params.set("waypoints", waypoints);

  return `https://www.google.com/maps/dir/?${params.toString()}`;
}

function renderRouteUI() {
  const list = document.getElementById("routeList");
  const link = document.getElementById("gmapsLink");
  if (!list || !link) return;

  if (routeClubs.length === 0) {
    list.textContent = "No stops yet.";
    link.style.display = "none";
    return;
  }

  list.innerHTML = routeClubs.map((c, i) => {
    const label =
      i === 0 ? "Start" :
      i === routeClubs.length - 1 ? "Destination" :
      `Stop ${i}`;
    return `${label}: <b>${c.name}</b>`;
  }).join("<br>");

  const url = buildGoogleMapsDirectionsUrl(routeClubs);
  if (url) {
    link.href = url;
    link.style.display = "inline-block";
  }
}

function addClubToRoute(club) {
  routeClubs.push(club);
  renderRouteUI();
}

function undoRoute() {
  routeClubs.pop();
  renderRouteUI();
}

function clearRoute() {
  routeClubs = [];
  renderRouteUI();
}

  // ---------- Selection + distances ----------
  function clearLines() { lineLayer.clearLayers(); }

  function drawLinesToNearest(fromLat, fromLng, limit = 10) {
    clearLines();
    const sorted = clubs
      .map(c => ({club: c, miles: haversineMiles(fromLat, fromLng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles)
      .slice(0, limit);

    sorted.forEach(({club}) => {
      L.polyline([[fromLat, fromLng],[club.lat, club.lng]], { weight: 2, opacity: 0.55 }).addTo(lineLayer);
    });
  }

  function renderDistances(fromLat, fromLng, titleHtml) {
    const radiusMiles = Number(document.getElementById('radius').value || 0);

    const rows = clubs
      .map(c => ({club: c, miles: haversineMiles(fromLat, fromLng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles)
      .filter(x => radiusMiles <= 0 ? true : x.miles <= radiusMiles);

    document.getElementById('selected').innerHTML = titleHtml;

    const tbody = document.querySelector('#results tbody');
    tbody.innerHTML = "";
    rows.forEach(({club, miles}) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight:900;">${esc(club.name)}</div>
          <div class="muted">${esc(club.address || "")}</div>
        </td>
        <td><span class="pill"><strong>${miles.toFixed(1)}</strong>&nbsp;mi</span></td>
      `;
      tr.addEventListener('click', () => {
        map.setView([club.lat, club.lng], 13);
        onSelectClub(club, true);
      });
      tbody.appendChild(tr);
    });

    document.getElementById('results').style.display = "table";
    document.getElementById('summary').innerHTML =
      `Showing <b>${rows.length}</b> clubs ${radiusMiles > 0 ? `within <b>${radiusMiles}</b> miles` : "(all clubs)"} from the selected point.`;
  }

  function onSelectClub(club, fromList=false) {
    selected = club;
    selectedType = "club";
    document.getElementById('modeLabel').textContent = "Club";

    const titleHtml = `<div><b>Selected club:</b> ${esc(club.name)}</div><div class="muted">${esc(club.address || "")}</div>`;
    document.getElementById('details').style.display = "block";
    document.getElementById('details').innerHTML = kvHtmlAllColumns(club);

    renderDistances(club.lat, club.lng, titleHtml);
    drawLinesToNearest(club.lat, club.lng, 10);

    if (!fromList) map.setView([club.lat, club.lng], Math.max(map.getZoom(), 11));
  }

  // ---------- Custom point ----------
  let customMarker = null;
  let pickMode = false;

  function setCustomPoint(lat, lng, label) {
    selectedType = "custom";
    selected = { name: label || "Custom point", lat, lng };
    document.getElementById('modeLabel').textContent = "Custom point";

    if (customMarker) map.removeLayer(customMarker);
    customMarker = L.circleMarker([lat, lng], { radius: 9, weight: 2, opacity: 0.9, fillOpacity: 0.35 }).addTo(map);
    customMarker.bindPopup(`<b>${esc(selected.name)}</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();

    document.getElementById('details').style.display = "block";
    document.getElementById('details').innerHTML = `
      <div class="kv">
        <div class="kvrow"><div class="k">Type</div><div class="v">Custom point</div></div>
        <div class="kvrow"><div class="k">Label</div><div class="v">${esc(selected.name)}</div></div>
        <div class="kvrow"><div class="k">Latitude</div><div class="v">${lat}</div></div>
        <div class="kvrow"><div class="k">Longitude</div><div class="v">${lng}</div></div>
      </div>
    `;

    const titleHtml = `<div><b>Selected point:</b> ${esc(selected.name)}</div><div class="muted">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>`;
    renderDistances(lat, lng, titleHtml);
    drawLinesToNearest(lat, lng, 10);

    map.setView([lat, lng], Math.max(map.getZoom(), 11));
  }

  async function geocodeAddress(address) {
    const url = new URL("https://nominatim.openstreetmap.org/search");
    url.searchParams.set("q", address);
    url.searchParams.set("format", "json");
    url.searchParams.set("limit", "1");
    url.searchParams.set("countrycodes", "us");

    const r = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
    if (!r.ok) throw new Error(`Geocode HTTP ${r.status}`);
    const data = await r.json();
    if (!data || !data.length) return null;
    return { lat: Number(data[0].lat), lng: Number(data[0].lon) };
  }

  // ---------- Load clubs ----------
  fetch('clubs.json')
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      clubs = (data || []).filter(c => typeof c.lat === "number" && typeof c.lng === "number");

      document.getElementById('clubCount').textContent = String(clubs.length);
      setStatus(`<strong>Loaded.</strong> Click a club, search, or set a custom point.`);

      const bounds = [];
      clubs.forEach(club => {
        const marker = L.marker([club.lat, club.lng]).addTo(map);
        marker.bindPopup(`<b>${esc(club.name)}</b><br>${esc(club.address || "")}<br><span class="muted">Click to select</span>`);
        marker.on('click', () => onSelectClub(club));
        markers.push({marker, club});
        bounds.push([club.lat, club.lng]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
      updateLabels();
    })
    .catch(err => {
      console.error(err);
      setStatus(`<span style="color:var(--danger)"><strong>Failed to load clubs.json</strong></span><br>
        <span class="muted">Make sure clubs.json is in the same folder as index.html and is valid JSON.</span>`);
      alert("Could not load clubs.json. Check file placement and JSON format.");
    });

  // ---------- UI wiring ----------
  document.getElementById('radius').addEventListener('input', () => {
    if (!selected) return;
    if (selectedType === "club") {
      renderDistances(selected.lat, selected.lng, `<div><b>Selected club:</b> ${esc(selected.name)}</div><div class="muted">${esc(selected.address || "")}</div>`);
      drawLinesToNearest(selected.lat, selected.lng, 10);
    } else {
      renderDistances(selected.lat, selected.lng, `<div><b>Selected point:</b> ${esc(selected.name)}</div><div class="muted">${selected.lat.toFixed(5)}, ${selected.lng.toFixed(5)}</div>`);
      drawLinesToNearest(selected.lat, selected.lng, 10);
    }
  });

  document.getElementById('clearLines').addEventListener('click', clearLines);

  document.getElementById('toggleLabels').addEventListener('click', () => {
    labelsEnabled = !labelsEnabled;
    document.getElementById('toggleLabels').textContent = labelsEnabled ? "Hide labels" : "Show labels";
    updateLabels();
  });

  // Search
  function findClubByName(q) {
    const query = (q || "").trim().toLowerCase();
    if (!query) return null;
    let exact = clubs.find(c => String(c.name).toLowerCase() === query);
    if (exact) return exact;
    return clubs.find(c => String(c.name).toLowerCase().includes(query)) || null;
  }

  document.getElementById('searchGo').addEventListener('click', () => {
    const q = document.getElementById('searchInput').value;
    const club = findClubByName(q);
    if (!club) {
      setStatus(`<strong>No match.</strong> Try a shorter name (example: “Brickyard”).`);
      return;
    }
    setStatus(`<strong>Found:</strong> ${esc(club.name)}.`);
    onSelectClub(club);
  });

  document.getElementById('searchClear').addEventListener('click', () => {
    document.getElementById('searchInput').value = "";
    setStatus(`<strong>Ready.</strong> Click a club, search, or set a custom point.`);
  });

  // Custom lat,lng
  document.getElementById('setLatLng').addEventListener('click', () => {
    const parsed = parseLatLng(document.getElementById('customLatLng').value);
    if (!parsed) {
      setStatus(`<span style="color:var(--danger)"><strong>Invalid lat,lng.</strong></span> Example: 40.7608,-111.8910`);
      return;
    }
    setStatus(`<strong>Custom point set.</strong> Using lat,lng.`);
    setCustomPoint(parsed.lat, parsed.lng, "Custom (lat,lng)");
  });

  // Custom address
  document.getElementById('geocodeAddress').addEventListener('click', async () => {
    const address = (document.getElementById('customAddress').value || "").trim();
    if (!address) {
      setStatus(`<span style="color:var(--danger)"><strong>Enter an address.</strong></span>`);
      return;
    }
    setStatus(`<strong>Geocoding…</strong> ${esc(address)}`);
    try {
      const pt = await geocodeAddress(address);
      if (!pt) {
        setStatus(`<span style="color:var(--danger)"><strong>No geocode result.</strong></span> Try adding city/state/zip.`);
        return;
      }
      setStatus(`<strong>Geocoded.</strong> Using address point.`);
      setCustomPoint(pt.lat, pt.lng, address);
    } catch (e) {
      console.error(e);
      setStatus(`<span style="color:var(--danger)"><strong>Geocode failed.</strong></span> If rate-limited, use lat,lng or “Pick point on map”.`);
      alert("Geocode failed. Try again, or use lat,lng.");
    }
  });

  // Pick point on map
  document.getElementById('useClickedPoint').addEventListener('click', () => {
    pickMode = !pickMode;
    setStatus(pickMode
      ? `<strong>Pick mode ON.</strong> Click anywhere on the map to set a custom point.`
      : `<strong>Pick mode OFF.</strong>`);
  });

  map.on('click', (e) => {
    if (!pickMode) return;
    pickMode = false;
    setStatus(`<strong>Custom point set.</strong> (Clicked on map)`);
    setCustomPoint(e.latlng.lat, e.latlng.lng, "Custom (map click)");
  });

  // Clear custom
  document.getElementById('clearCustom').addEventListener('click', () => {
    if (customMarker) {
      map.removeLayer(customMarker);
      customMarker = null;
    }
    selected = null;
    selectedType = "none";
    document.getElementById('modeLabel').textContent = "Click a club";
    document.getElementById('selected').innerHTML = "Click a club marker, or set a custom point.";
    document.getElementById('details').style.display = "none";
    document.getElementById('summary').innerHTML = "";
    document.getElementById('results').style.display = "none";
    document.getElementById("routeUndo")?.addEventListener("click", undoRoute);
document.getElementById("routeClear")?.addEventListener("click", clearRoute);
renderRouteUI();
    
    clearLines();
    setStatus(`<strong>Cleared.</strong> Click a club, search, or set a custom point.`);
  });
</script>
</body>
</html>


