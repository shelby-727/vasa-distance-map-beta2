<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VASA Clubs — Distance Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#101f38;
      --text:#eaf0ff;
      --muted:#a9b8df;
      --line:rgba(255,255,255,0.10);
      --accent:#7aa7ff;
      --danger:#ff6b6b;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --radius: 16px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:var(--font); background:var(--bg); color:var(--text); }
    .wrap { display:flex; height:100vh; width:100vw; overflow:hidden; }
    #map { flex:1 1 auto; }

    .panel {
      width: 420px;
      max-width: 50vw;
      min-width: 320px;
      border-left: 1px solid var(--line);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;
    }

    .header {
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.03);
      margin-bottom: 12px;
    }
    .h-title { font-weight:900; letter-spacing:.2px; font-size:14px; }
    .h-sub { color:var(--muted); font-size:12px; margin-top:2px; }

    .section {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.03);
    }
    .section h3 { margin:0 0 8px; font-size:13px; letter-spacing:.2px; }

    .muted { color:var(--muted); font-size:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input, button {
      font-family: var(--font);
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 9px 10px;
      outline: none;
    }
    button {
      cursor:pointer;
      background: rgba(122,167,255,0.15);
      border-color: rgba(122,167,255,0.30);
    }
    button:hover { background: rgba(122,167,255,0.22); }
    button.secondary { background: rgba(255,255,255,0.04); border-color: var(--line); }

    .pill {
      display:inline-flex; gap:6px; align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      font-size:12px;
      color: var(--muted);
    }
    .pill strong { color: var(--text); }

    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; padding: 9px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 12px; vertical-align: top; }
    th { color: var(--muted); font-weight: 700; }
    tr:hover { background: rgba(255,255,255,0.03); cursor:pointer; }

    .label-tooltip {
      background: rgba(15,26,46,0.92);
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--text);
      border-radius: 10px;
      padding: 2px 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      font-weight: 900;
      font-size: 11px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div id="map"></div>

  <div class="panel">
    <div class="header">
      <div class="h-title">VASA Distance Finder</div>
      <div class="h-sub">Click a club marker to see distances to all other clubs.</div>
    </div>

    <div class="section">
      <h3>Distance options</h3>
      <div class="row">
        <span class="muted">Within (miles):</span>
        <input id="radius" type="number" min="0" step="5" value="0" />
        <button id="clearLines" class="secondary" type="button">Clear lines</button>
      </div>
      <div class="muted" style="margin-top:8px;">Club labels show at zoom 12+.</div>
    </div>

    <div class="section">
      <h3>Selected club</h3>
      <div id="selected" class="muted">No club selected yet.</div>
      <div id="summary" class="muted" style="margin-top:10px;"></div>

      <table id="results" style="display:none;">
        <thead>
          <tr><th>Club</th><th>Distance</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<script>
  // ---------- Helpers ----------
  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function haversineMiles(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 3958.7613;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // ---------- Map ----------
  const map = L.map('map').setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Use LOCAL Leaflet marker icons (repo root)
  L.Icon.Default.mergeOptions({
    iconRetinaUrl: './marker-icon-2x.png',
    iconUrl: './marker-icon.png',
    shadowUrl: './marker-shadow.png'
  });

  const lineLayer = L.layerGroup().addTo(map);

  let clubs = [];
  let markers = []; // {marker, club}
  let selectedClub = null;

  // Labels
  let labelsEnabled = true;
  const labelZoomThreshold = 12;

  function updateLabels() {
    const z = map.getZoom();
    markers.forEach(({marker, club}) => {
      if (!labelsEnabled || z < labelZoomThreshold) {
        marker.unbindTooltip();
        return;
      }
      if (!marker.getTooltip()) {
        marker.bindTooltip(esc(club.name), {
          permanent: true,
          direction: "top",
          offset: [0, -10],
          className: "label-tooltip"
        });
      }
    });
  }
  map.on('zoomend', updateLabels);

  function clearLines() { lineLayer.clearLayers(); }

  function drawLinesToNearest(limit = 10) {
    clearLines();
    if (!selectedClub) return;

    const sorted = clubs
      .filter(c => c !== selectedClub)
      .map(c => ({club: c, miles: haversineMiles(selectedClub.lat, selectedClub.lng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles)
      .slice(0, limit);

    sorted.forEach(({club}) => {
      L.polyline([[selectedClub.lat, selectedClub.lng],[club.lat, club.lng]], { weight: 2, opacity: 0.55 }).addTo(lineLayer);
    });
  }

  function renderDistances() {
    if (!selectedClub) return;

    const radiusMiles = Number(document.getElementById('radius').value || 0);

    const rows = clubs
      .filter(c => c !== selectedClub)
      .map(c => ({club: c, miles: haversineMiles(selectedClub.lat, selectedClub.lng, c.lat, c.lng)}))
      .sort((a,b) => a.miles - b.miles)
      .filter(x => radiusMiles <= 0 ? true : x.miles <= radiusMiles);

    document.getElementById('selected').innerHTML =
      `<div><b>${esc(selectedClub.name)}</b></div><div class="muted">${esc(selectedClub.address || "")}</div>`;

    const tbody = document.querySelector('#results tbody');
    tbody.innerHTML = "";

    rows.forEach(({club, miles}) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight:900;">${esc(club.name)}</div>
          <div class="muted">${esc(club.address || "")}</div>
        </td>
        <td><span class="pill"><strong>${miles.toFixed(1)}</strong>&nbsp;mi</span></td>
      `;
      tr.addEventListener('click', () => map.setView([club.lat, club.lng], 13));
      tbody.appendChild(tr);
    });

    document.getElementById('results').style.display = "table";
    document.getElementById('summary').innerHTML =
      `Showing <b>${rows.length}</b> clubs ${radiusMiles > 0 ? `within <b>${radiusMiles}</b> miles` : "(all clubs)"} of the selected club.`;
  }

  function onSelectClub(club) {
    selectedClub = club;

    // Keep popup simple (no details)
    // Update table + draw lines
    renderDistances();
    drawLinesToNearest(10);

    map.setView([club.lat, club.lng], Math.max(map.getZoom(), 11));
  }

  // ---------- Load clubs ----------
  fetch('./clubs.json')
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      clubs = (data || [])
        .map(c => ({...c, lat: Number(c.lat), lng: Number(c.lng)}))
        .filter(c => Number.isFinite(c.lat) && Number.isFinite(c.lng));

      const bounds = [];
      clubs.forEach(club => {
        const marker = L.marker([club.lat, club.lng]).addTo(map);

        marker.bindPopup(`<b>${esc(club.name)}</b><br>${esc(club.address || "")}`);

        marker.on('click', () => onSelectClub(club));

        markers.push({ marker, club });
        bounds.push([club.lat, club.lng]);
      });

      if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });
      updateLabels();
    })
    .catch(err => {
      console.error(err);
      alert("Could not load clubs.json. Make sure it’s in the same folder as index.html and valid JSON.");
    });

  // ---------- UI wiring ----------
  document.getElementById('radius').addEventListener('input', () => renderDistances());
  document.getElementById('clearLines').addEventListener('click', clearLines);
</script>
</body>
</html>
